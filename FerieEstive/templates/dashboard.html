{% extends 'base.html' %}
{% block title %}Scelta Ferie â€“ {{ dipendente.nome_completo }}{% endblock %}

{% block content %}
<div class="mt-4">

  <!-- Header -->
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div>
      <h4 class="mb-0 fw-bold">
        <i class="bi bi-sun-fill text-warning me-2"></i>Scelta Ferie Estive 2026
      </h4>
      <div class="text-muted small mt-1">
        <i class="bi bi-person-circle me-1"></i>{{ dipendente.nome_completo }}
      </div>
    </div>
    {% if scelta and scelta.settimana_ferragosto %}
      <span class="badge bg-success fs-6 px-3 py-2">
        <i class="bi bi-check-circle me-1"></i>Scelta salvata
      </span>
    {% else %}
      <span class="badge bg-warning text-dark fs-6 px-3 py-2">
        <i class="bi bi-clock me-1"></i>Nessuna scelta salvata
      </span>
    {% endif %}
  </div>

  <!-- Pannello 4 slot -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body p-3">
      <div class="row g-2">

        <!-- Slot 1: Ferragosto (obbligatorio) â€” click scrolls to picker -->
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="slot-label ferragosto-label">
            <i class="bi bi-sun me-1"></i>SETT. FERRAGOSTO <span class="text-danger">*</span>
          </div>
          <div id="badge-ferragosto"
               class="selection-badge ferragosto {% if scelta and scelta.settimana_ferragosto %}active{% endif %}"
               onclick="document.getElementById('ferragosto-picker').scrollIntoView({behavior:'smooth'})">
            {% if scelta and scelta.settimana_ferragosto %}
              {% set wi = get_week_info(scelta.settimana_ferragosto) %}
              <i class="bi bi-calendar-check me-1"></i>
              Sett. {{ scelta.settimana_ferragosto }}
              <span class="d-block small mt-1 opacity-75">{{ wi['inizio'].strftime('%d/%m') }} â€“ {{ wi['fine'].strftime('%d/%m') }}</span>
            {% else %}
              <i class="bi bi-hand-index me-1"></i>Scegli qui sotto
            {% endif %}
          </div>
        </div>

        <!-- Slot 2: Aggiuntiva -->
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="slot-label aggiuntiva-label">
            <i class="bi bi-plus-circle me-1"></i>SETT. AGGIUNTIVA
          </div>
          <div id="badge-aggiuntiva"
               class="selection-badge aggiuntiva {% if scelta and scelta.settimana_aggiuntiva %}active{% endif %}"
               onclick="activateSlot('aggiuntiva')">
            {% if scelta and scelta.settimana_aggiuntiva %}
              {% set wi = get_week_info(scelta.settimana_aggiuntiva) %}
              <i class="bi bi-calendar-check me-1"></i>
              Sett. {{ scelta.settimana_aggiuntiva }}
              <span class="d-block small mt-1 opacity-75">{{ wi['inizio'].strftime('%d/%m') }} â€“ {{ wi['fine'].strftime('%d/%m') }}</span>
            {% else %}
              <i class="bi bi-hand-index me-1"></i>Clicca una settimana
            {% endif %}
          </div>
        </div>

        <!-- Slot 3: Riserva aggiuntiva -->
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="slot-label riserva-label">
            <i class="bi bi-bookmark me-1"></i>RISERVA AGGIUNTIVA
          </div>
          <div id="badge-riserva"
               class="selection-badge riserva {% if scelta and scelta.settimana_riserva %}active{% endif %}"
               onclick="activateSlot('riserva')">
            {% if scelta and scelta.settimana_riserva %}
              {% set wi = get_week_info(scelta.settimana_riserva) %}
              <i class="bi bi-calendar-check me-1"></i>
              Sett. {{ scelta.settimana_riserva }}
              <span class="d-block small mt-1 opacity-75">{{ wi['inizio'].strftime('%d/%m') }} â€“ {{ wi['fine'].strftime('%d/%m') }}</span>
            {% else %}
              <i class="bi bi-hand-index me-1"></i>Clicca una settimana
            {% endif %}
          </div>
        </div>

        <!-- Slot 4: Quarta -->
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="slot-label quarta-label">
            <i class="bi bi-gift me-1"></i>4Âª SETTIMANA
            {% if not quarta_disponibile %}
              <span class="badge bg-secondary ms-1" style="font-size:.6rem">Non disp.</span>
            {% endif %}
          </div>
          <div id="badge-quarta"
               class="selection-badge quarta {% if scelta and scelta.settimana_quarta %}active{% elif not quarta_disponibile %}disabled-slot{% endif %}"
               onclick="activateSlot('quarta')">
            {% if scelta and scelta.settimana_quarta %}
              {% set wi = get_week_info(scelta.settimana_quarta) %}
              <i class="bi bi-calendar-check me-1"></i>
              Sett. {{ scelta.settimana_quarta }}
              <span class="d-block small mt-1 opacity-75">{{ wi['inizio'].strftime('%d/%m') }} â€“ {{ wi['fine'].strftime('%d/%m') }}</span>
            {% elif quarta_disponibile %}
              <i class="bi bi-hand-index me-1"></i>Clicca una settimana
            {% else %}
              <i class="bi bi-lock me-1"></i>Non disponibile
            {% endif %}
          </div>
        </div>

      </div><!-- /row -->
    </div>

    <!-- Footer form + save -->
    <div class="card-footer bg-light">
      <form id="form-scelta" method="POST" action="{{ url_for('salva_scelta') }}"
            class="d-flex flex-wrap gap-2 align-items-center">
        <input type="hidden" id="inp-ferragosto" name="settimana_ferragosto"
               value="{{ scelta.settimana_ferragosto if scelta and scelta.settimana_ferragosto else '' }}">
        <input type="hidden" id="inp-aggiuntiva"  name="settimana_aggiuntiva"
               value="{{ scelta.settimana_aggiuntiva if scelta and scelta.settimana_aggiuntiva else '' }}">
        <input type="hidden" id="inp-riserva"     name="settimana_riserva"
               value="{{ scelta.settimana_riserva if scelta and scelta.settimana_riserva else '' }}">
        <input type="hidden" id="inp-quarta"      name="settimana_quarta"
               value="{{ scelta.settimana_quarta if scelta and scelta.settimana_quarta else '' }}">

        <div class="text-muted small flex-grow-1">
          {% if impostazioni and impostazioni.note %}
            <i class="bi bi-megaphone me-1 text-primary"></i>{{ impostazioni.note }}
          {% else %}
            <i class="bi bi-info-circle me-1"></i>
            Obbligatoria la settimana ferragosto. Le altre sono opzionali.
          {% endif %}
        </div>

        <button type="button" id="btn-reset-aggiuntiva" class="btn btn-outline-secondary btn-sm" style="display:none"
                onclick="resetSlot('aggiuntiva')">
          <i class="bi bi-x me-1"></i>Rimuovi aggiuntiva
        </button>
        <button type="button" id="btn-reset-riserva" class="btn btn-outline-secondary btn-sm" style="display:none"
                onclick="resetSlot('riserva')">
          <i class="bi bi-x me-1"></i>Rimuovi riserva
        </button>
        <button type="button" id="btn-reset-quarta" class="btn btn-outline-secondary btn-sm" style="display:none"
                onclick="resetSlot('quarta')">
          <i class="bi bi-x me-1"></i>Rimuovi 4Âª
        </button>

        <button type="submit" id="btn-salva" class="btn btn-primary fw-semibold px-4" disabled>
          <i class="bi bi-save me-2"></i>Salva scelta
        </button>
      </form>
    </div>
  </div>

  <!-- â”€â”€ STEP 1: PICKER SETTIMANA FERRAGOSTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="ferragosto-picker" class="card border-0 shadow-sm mb-4">
    <div class="card-header fw-semibold"
         style="background: linear-gradient(135deg, #fff7ed, #fef3c7); border-left: 3px solid #f97316; color: #92400e;">
      <i class="bi bi-sun-fill text-warning me-2"></i>
      STEP 1 &ndash; Settimana di Ferragosto <span class="text-danger ms-1">*</span>
      <span class="text-muted small ms-2 fw-normal">Scegli la settimana contigua al 15 agosto</span>
    </div>
    <div class="alert alert-warning mb-0 py-2 px-3 rounded-0 border-0 small"
         style="background:#fef9c3; border-left:3px solid #f97316 !important;">
      <i class="bi bi-info-circle-fill me-1 text-warning"></i>
      <strong>Settimana 33 (10â€“16 agosto)</strong> &mdash; Ã¨ la settimana di Ferragosto ed Ã¨
      <strong>assegnata automaticamente a tutti</strong>. Non Ã¨ selezionabile. Scegli qui sotto
      la settimana <em>aggiuntiva contigua</em>: la 32 (prima) o la 34 (dopo).
    </div>
    <div class="card-body p-3">
      <div class="row g-3 justify-content-center">
        {% for w in ferragosto_weeks %}
          {% set is_f = scelta and scelta.settimana_ferragosto == w.numero %}
          {% set is_pre = w.numero == settimana_pre_ferragosto %}
          <div class="col-12 col-sm-5">
            <div class="week-card ferragosto-picker-card text-center position-relative
                         {{ 'selected-ferragosto' if is_f else '' }}"
                 data-week="{{ w.numero }}"
                 data-label="{{ w.label }}"
                 data-piena="{{ 'true' if w.piena else 'false' }}"
                 onclick="selectFerragostoWeek({{ w.numero }})">
              <div class="ferragosto-card-title fw-bold fs-6 mb-1"
                   style="color: {{ '#c2410c' if is_f else '#6c757d' }}">
                {% if is_pre %}â˜€ PRIMA DI FERRAGOSTO{% else %}ðŸŒ™ DOPO FERRAGOSTO{% endif %}
              </div>
              <div class="week-num">Settimana {{ w.numero }}</div>
              <div class="week-dates">
                {{ w.inizio.strftime('%d %b') }} &ndash; {{ w.fine.strftime('%d %b %Y') }}
              </div>
              {% if is_f %}
                <div class="week-badge ferragosto-badge">â˜€ Ferragosto</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="text-center mt-2">
        <button type="button" id="btn-reset-ferragosto" class="btn btn-outline-secondary btn-sm"
                onclick="resetFerragosto()"
                style="{{ '' if scelta and scelta.settimana_ferragosto else 'display:none' }}">
          <i class="bi bi-x me-1"></i>Rimuovi selezione ferragosto
        </button>
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 2: CALENDARIO SETTIMANE AGGIUNTIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">
    <span class="fw-semibold small" style="color:#0a58ca">
      <i class="bi bi-calendar3 me-1"></i>STEP 2 &ndash; Settimane aggiuntive
      <span class="text-muted fw-normal">(opzionale)</span>
    </span>
    <span class="text-muted small">
      Seleziona uno slot (Aggiuntiva / Riserva / 4Âª) poi clicca una settimana nel calendario
    </span>
  </div>

  <!-- PRIMA DI FERRAGOSTO -->
  {% if settimane_prima %}
  <div class="mb-4">
    <div class="section-header prima-header mb-2">
      <i class="bi bi-brightness-high me-2"></i>
      PRIMA DI FERRAGOSTO
      <span class="ms-2 text-muted small fw-normal">giugno â€“ 9 agosto 2026</span>
    </div>
    <div class="row g-2">
      {% for w in settimane_prima %}
        {% set is_f = scelta and scelta.settimana_ferragosto == w.numero %}
        {% set is_a = scelta and scelta.settimana_aggiuntiva == w.numero %}
        {% set is_r = scelta and scelta.settimana_riserva    == w.numero %}
        {% set is_q = scelta and scelta.settimana_quarta     == w.numero %}
        <div class="col-6 col-md-3 col-lg-2">
          <div class="week-card
               {% if is_f %}selected-ferragosto
               {% elif is_a %}selected-aggiuntiva
               {% elif is_r %}selected-riserva
               {% elif is_q %}selected-quarta
               {% endif %}
               {% if w.piena %}week-full{% endif %}"
               data-week="{{ w.numero }}"
               data-label="{{ w.label }}"
               data-piena="{{ 'true' if w.piena else 'false' }}"
               onclick="selectWeek(this)">
            <div class="week-num">Sett. {{ w.numero }}</div>
            <div class="week-dates">{{ w.inizio.strftime('%d/%m') }} â€“ {{ w.fine.strftime('%d/%m') }}</div>
            {% if is_f %}<div class="week-badge ferragosto-badge">â˜€ Ferragosto</div>
            {% elif is_a %}<div class="week-badge aggiuntiva-badge">+ Aggiuntiva</div>
            {% elif is_r %}<div class="week-badge riserva-badge">â—ˆ Riserva</div>
            {% elif is_q %}<div class="week-badge quarta-badge">â—† 4Âª</div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- DOPO FERRAGOSTO -->
  {% if settimane_dopo %}
  <div class="mb-4">
    <div class="section-header dopo-header mb-2">
      <i class="bi bi-moon-stars me-2"></i>
      DOPO FERRAGOSTO
      <span class="ms-2 text-muted small fw-normal">10 agosto â€“ 4 ottobre 2026</span>
    </div>
    <div class="row g-2">
      {% for w in settimane_dopo %}
        {% set is_f = scelta and scelta.settimana_ferragosto == w.numero %}
        {% set is_a = scelta and scelta.settimana_aggiuntiva == w.numero %}
        {% set is_r = scelta and scelta.settimana_riserva    == w.numero %}
        {% set is_q = scelta and scelta.settimana_quarta     == w.numero %}
        <div class="col-6 col-md-3 col-lg-2">
          <div class="week-card
               {% if is_f %}selected-ferragosto
               {% elif is_a %}selected-aggiuntiva
               {% elif is_r %}selected-riserva
               {% elif is_q %}selected-quarta
               {% endif %}
               {% if w.piena %}week-full{% endif %}"
               data-week="{{ w.numero }}"
               data-label="{{ w.label }}"
               data-piena="{{ 'true' if w.piena else 'false' }}"
               onclick="selectWeek(this)">
            <div class="week-num">Sett. {{ w.numero }}</div>
            <div class="week-dates">{{ w.inizio.strftime('%d/%m') }} â€“ {{ w.fine.strftime('%d/%m') }}</div>
            {% if is_f %}<div class="week-badge ferragosto-badge">â˜€ Ferragosto</div>
            {% elif is_a %}<div class="week-badge aggiuntiva-badge">+ Aggiuntiva</div>
            {% elif is_r %}<div class="week-badge riserva-badge">â—ˆ Riserva</div>
            {% elif is_q %}<div class="week-badge quarta-badge">â—† 4Âª</div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if not settimane_prima and not settimane_dopo %}
  <div class="text-center text-muted py-5">
    <i class="bi bi-calendar-x fs-1 d-block mb-3"></i>
    Nessuna settimana disponibile. Contatta l'amministratore.
  </div>
  {% endif %}

</div><!-- /mt-4 -->
{% endblock %}

{% block scripts %}
<script>
const state = {
  ferragosto: {{ (scelta.settimana_ferragosto|int if scelta and scelta.settimana_ferragosto else 'null') }},
  aggiuntiva: {{ (scelta.settimana_aggiuntiva|int if scelta and scelta.settimana_aggiuntiva else 'null') }},
  riserva:    {{ (scelta.settimana_riserva|int    if scelta and scelta.settimana_riserva    else 'null') }},
  quarta:     {{ (scelta.settimana_quarta|int     if scelta and scelta.settimana_quarta     else 'null') }},
};
const quartaAbilitata = {{ 'true' if quarta_disponibile else 'false' }};
let activeSlot = null;

// aggiuntiva/riserva/quarta only â€” ferragosto has its own picker
const SLOT_ORDER = ['aggiuntiva', 'riserva', 'quarta'];

const PLACEHOLDERS = {
  aggiuntiva: '<i class="bi bi-hand-index me-1"></i>Clicca una settimana',
  riserva:    '<i class="bi bi-hand-index me-1"></i>Clicca una settimana',
  quarta:     quartaAbilitata
              ? '<i class="bi bi-hand-index me-1"></i>Clicca una settimana'
              : '<i class="bi bi-lock me-1"></i>Non disponibile',
};

const BADGE_LABELS = {
  ferragosto: '\u2600 Ferragosto',
  aggiuntiva: '+ Aggiuntiva',
  riserva:    '\u25C8 Riserva',
  quarta:     '\u25C6 4\u00AA',
};

// â”€â”€ Ferragosto picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function selectFerragostoWeek(weekNum) {
  if (state.ferragosto === weekNum) {
    resetFerragosto();
    return;
  }
  // Remove ferragosto style from old main-grid card (if any)
  if (state.ferragosto) {
    const oldCard = document.querySelector(
      `.week-card:not(.ferragosto-picker-card)[data-week="${state.ferragosto}"]`);
    if (oldCard) {
      oldCard.classList.remove('selected-ferragosto');
      const wb = oldCard.querySelector('.week-badge');
      if (wb) wb.remove();
    }
  }
  state.ferragosto = weekNum;
  document.getElementById('inp-ferragosto').value = weekNum;
  updateFerragostoCards();
  updateFerragostoBadge(weekNum);
  // Also mark main-grid card (week 32 or 34 appears there too)
  const mainCard = document.querySelector(
    `.week-card:not(.ferragosto-picker-card)[data-week="${weekNum}"]`);
  if (mainCard) {
    mainCard.classList.remove('selected-aggiuntiva', 'selected-riserva', 'selected-quarta');
    mainCard.classList.add('selected-ferragosto');
    const wb = mainCard.querySelector('.week-badge');
    if (wb) wb.remove();
    const badge = document.createElement('div');
    badge.className = 'week-badge ferragosto-badge';
    badge.textContent = BADGE_LABELS.ferragosto;
    mainCard.appendChild(badge);
  }
  updateUI();
}

function resetFerragosto() {
  if (state.ferragosto) {
    const oldCard = document.querySelector(
      `.week-card:not(.ferragosto-picker-card)[data-week="${state.ferragosto}"]`);
    if (oldCard) {
      oldCard.classList.remove('selected-ferragosto');
      const wb = oldCard.querySelector('.week-badge');
      if (wb) wb.remove();
    }
  }
  state.ferragosto = null;
  document.getElementById('inp-ferragosto').value = '';
  updateFerragostoCards();
  const badgeEl = document.getElementById('badge-ferragosto');
  badgeEl.classList.remove('active');
  badgeEl.innerHTML = '<i class="bi bi-hand-index me-1"></i>Scegli qui sotto';
  updateUI();
}

function updateFerragostoCards() {
  document.querySelectorAll('.ferragosto-picker-card').forEach(card => {
    const n = parseInt(card.dataset.week);
    const selected = state.ferragosto === n;
    card.classList.toggle('selected-ferragosto', selected);
    const title = card.querySelector('.ferragosto-card-title');
    if (title) title.style.color = selected ? '#c2410c' : '#6c757d';
    const existing = card.querySelector('.week-badge');
    if (existing) existing.remove();
    if (selected) {
      const badge = document.createElement('div');
      badge.className = 'week-badge ferragosto-badge';
      badge.textContent = BADGE_LABELS.ferragosto;
      card.appendChild(badge);
    }
  });
}

function updateFerragostoBadge(weekNum) {
  const card = document.querySelector(`.ferragosto-picker-card[data-week="${weekNum}"]`);
  const label = card ? card.dataset.label : `Sett. ${weekNum}`;
  const [sett, dates] = label.split(' \u2013 ');
  const badgeEl = document.getElementById('badge-ferragosto');
  badgeEl.classList.add('active');
  badgeEl.innerHTML = `<i class="bi bi-calendar-check me-1"></i>${sett}
    <span class="d-block small mt-1 opacity-75">${dates || ''}</span>`;
}

// â”€â”€ Main calendar (aggiuntiva / riserva / quarta) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function activateSlot(type) {
  if (type === 'quarta' && !quartaAbilitata) return;
  if (activeSlot === type) {
    activeSlot = null;
    document.querySelectorAll('.selection-badge').forEach(b => b.classList.remove('selecting'));
    highlightWeeks();
    return;
  }
  activeSlot = type;
  document.querySelectorAll('.selection-badge').forEach(b => b.classList.remove('selecting'));
  document.getElementById('badge-' + type).classList.add('selecting');
  highlightWeeks();
}

function highlightWeeks() {
  const taken = Object.values(state).filter(Boolean);
  document.querySelectorAll('.week-card:not(.ferragosto-picker-card)').forEach(card => {
    card.classList.remove('week-highlight');
    if (activeSlot && card.dataset.piena !== 'true') {
      const n = parseInt(card.dataset.week);
      if (!taken.includes(n) || n === state[activeSlot]) {
        card.classList.add('week-highlight');
      }
    }
  });
}

function selectWeek(card) {
  if (card.classList.contains('ferragosto-picker-card')) return;

  if (!activeSlot) {
    for (const s of SLOT_ORDER) {
      if (s === 'quarta' && !quartaAbilitata) continue;
      if (!state[s]) { activateSlot(s); break; }
    }
    if (!activeSlot) return;
  }
  if (activeSlot === 'quarta' && !quartaAbilitata) return;

  const n     = parseInt(card.dataset.week);
  const piena = card.dataset.piena === 'true';

  // Block if already used as ferragosto
  if (state.ferragosto === n) {
    showToast('Questa settimana Ã¨ giÃ  selezionata come settimana ferragosto.', 'warning');
    return;
  }

  if (piena && state[activeSlot] !== n) {
    showToast("Settimana completa, scegli un'altra.", 'warning');
    return;
  }

  // Duplicate check among aggiuntiva/riserva/quarta
  const others = Object.entries(state)
    .filter(([k]) => k !== activeSlot && k !== 'ferragosto')
    .map(([, v]) => v);
  if (others.includes(n)) {
    showToast("Hai giÃ  selezionato questa settimana per un altro slot.", 'warning');
    return;
  }

  const old = state[activeSlot];
  if (old) clearCardStyle(old);

  state[activeSlot] = n;
  document.getElementById('inp-' + activeSlot).value = n;

  card.classList.add('selected-' + activeSlot);
  const wb = card.querySelector('.week-badge');
  if (wb) wb.remove();
  const badge = document.createElement('div');
  badge.className = `week-badge ${activeSlot}-badge`;
  badge.textContent = BADGE_LABELS[activeSlot];
  card.appendChild(badge);

  const badgeEl = document.getElementById('badge-' + activeSlot);
  badgeEl.classList.add('active');
  badgeEl.classList.remove('selecting');
  const [sett, dates] = card.dataset.label.split(' \u2013 ');
  badgeEl.innerHTML = `<i class="bi bi-calendar-check me-1"></i>${sett}
    <span class="d-block small mt-1 opacity-75">${dates || ''}</span>`;

  activeSlot = null;
  highlightWeeks();
  updateUI();
}

function clearCardStyle(weekNum) {
  const card = document.querySelector(
    `.week-card:not(.ferragosto-picker-card)[data-week="${weekNum}"]`);
  if (!card) return;
  card.classList.remove('selected-ferragosto', 'selected-aggiuntiva',
                         'selected-riserva', 'selected-quarta');
  const wb = card.querySelector('.week-badge');
  if (wb) wb.remove();
}

function resetSlot(type) {
  const old = state[type];
  if (old) clearCardStyle(old);
  state[type] = null;
  document.getElementById('inp-' + type).value = '';
  const badgeEl = document.getElementById('badge-' + type);
  badgeEl.classList.remove('active', 'selecting');
  badgeEl.innerHTML = PLACEHOLDERS[type];
  highlightWeeks();
  updateUI();
}

function updateUI() {
  document.getElementById('btn-salva').disabled = !state.ferragosto;
  const btnF = document.getElementById('btn-reset-ferragosto');
  if (btnF) btnF.style.display = state.ferragosto ? 'inline-block' : 'none';
  ['aggiuntiva', 'riserva', 'quarta'].forEach(t => {
    const btn = document.getElementById('btn-reset-' + t);
    if (btn) btn.style.display = state[t] ? 'inline-block' : 'none';
  });
}

function showToast(msg, type) {
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = 1100;
    document.body.appendChild(container);
  }
  const id = 'toast-' + Date.now();
  container.insertAdjacentHTML('beforeend', `
    <div id="${id}" class="toast align-items-center text-bg-${type === 'warning' ? 'warning text-dark' : 'danger'} border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body fw-semibold">${msg}</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`);
  new bootstrap.Toast(document.getElementById(id), { delay: 3000 }).show();
}

// Init
updateUI();
</script>
{% endblock %}
