<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rubrica Aziendale</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
  <style>
    body { background: #f4f6fb; }
    .navbar-brand { font-weight: 700; letter-spacing: .5px; }
    #searchBox { max-width: 340px; }
    .table-hover tbody tr { cursor: pointer; }
    .badge-tariffa { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    .commento-cell { max-width: 200px; white-space: nowrap;
                     overflow: hidden; text-overflow: ellipsis; }
    .btn-action { padding: 2px 8px; font-size: .8rem; }
    #emptyMsg { display: none; }
    .modal-header { background: #1a237e; color: #fff; }
    .modal-header .btn-close { filter: invert(1); }
    textarea#commenti { resize: vertical; min-height: 80px; }
    .detail-label { font-weight: 600; color: #555; min-width: 120px; display: inline-block; }
    .detail-value { color: #222; }
    .detail-commento { white-space: pre-wrap; background: #f8f9fa;
                       border-radius: 6px; padding: 8px 12px;
                       border: 1px solid #dee2e6; }
    .sort-icon { font-size: .75rem; vertical-align: middle; }
    th[data-col] { cursor: pointer; user-select: none; }
    th[data-col]:hover { background: #e8eaf6; }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark" style="background:#1a237e;">
  <div class="container-fluid">
    <span class="navbar-brand">
      <i class="bi bi-telephone-fill me-2"></i>Rubrica Aziendale
    </span>
    <div class="d-flex gap-2 align-items-center">
      <input id="searchBox" type="search" class="form-control form-control-sm"
             placeholder="Cerca nome, azienda, telefonoâ€¦"/>
      <button class="btn btn-success btn-sm" onclick="apriNuovo()">
        <i class="bi bi-plus-lg"></i> Nuovo
      </button>
    </div>
  </div>
</nav>

<!-- TABELLA -->
<div class="container-fluid mt-3">
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-bordered mb-0" id="tbl">
          <thead class="table-dark">
            <tr>
              <th data-col="cognome">Cognome <i class="bi bi-arrow-down-up sort-icon"></i></th>
              <th data-col="nome">Nome <i class="bi bi-arrow-down-up sort-icon"></i></th>
              <th data-col="azienda">Azienda <i class="bi bi-arrow-down-up sort-icon"></i></th>
              <th data-col="reparto">Reparto</th>
              <th data-col="telefono">Telefono</th>
              <th data-col="cellulare">Cellulare</th>
              <th data-col="email">Email</th>
              <th data-col="tariffa">Tariffa</th>
              <th>Commenti</th>
              <th style="width:90px;">Azioni</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="emptyMsg" class="text-center text-muted py-5">
        <i class="bi bi-search display-4 d-block mb-2"></i>Nessun contatto trovato.
      </div>
    </div>
  </div>
  <div class="text-muted small mt-2" id="countMsg"></div>
</div>

<!-- MODAL FORM (crea / modifica) -->
<div class="modal fade" id="modalForm" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Nuovo contatto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formContatto" novalidate>
          <input type="hidden" id="fId"/>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Nome <span class="text-danger">*</span></label>
              <input id="fNome" type="text" class="form-control" required/>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Cognome <span class="text-danger">*</span></label>
              <input id="fCognome" type="text" class="form-control" required/>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Azienda</label>
              <input id="fAzienda" type="text" class="form-control"/>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Reparto</label>
              <input id="fReparto" type="text" class="form-control"/>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Telefono</label>
              <input id="fTelefono" type="tel" class="form-control"/>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Cellulare</label>
              <input id="fCellulare" type="tel" class="form-control"/>
            </div>
            <div class="col-md-12">
              <label class="form-label fw-semibold">Email</label>
              <input id="fEmail" type="email" class="form-control"/>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Tariffa</label>
              <div class="input-group">
                <input id="fTariffa" type="number" step="0.01" min="0"
                       class="form-control" placeholder="0.00"/>
                <select id="fValuta" class="form-select" style="max-width:90px;">
                  <option value="EUR">EUR</option>
                  <option value="USD">USD</option>
                  <option value="GBP">GBP</option>
                  <option value="CHF">CHF</option>
                </select>
              </div>
            </div>
            <div class="col-md-12">
              <label class="form-label fw-semibold">Commenti</label>
              <textarea id="fCommenti" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        <button class="btn btn-primary" onclick="salvaContatto()">
          <i class="bi bi-floppy"></i> Salva
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DETTAGLIO -->
<div class="modal fade" id="modalDetail" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailTitle">Dettaglio contatto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detailBody"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        <button class="btn btn-warning" id="detailEditBtn">
          <i class="bi bi-pencil"></i> Modifica
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CONFERMA ELIMINAZIONE -->
<div class="modal fade" id="modalDel" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h6 class="modal-title">Conferma eliminazione</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="delMsg">Eliminare il contatto?</div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Annulla</button>
        <button class="btn btn-danger btn-sm" id="delConfirmBtn">Elimina</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ------------------------------------------------------------------ */
/*  State                                                               */
/* ------------------------------------------------------------------ */
let contatti = [];
let sortCol = "cognome", sortAsc = true;

const modalForm   = new bootstrap.Modal(document.getElementById("modalForm"));
const modalDetail = new bootstrap.Modal(document.getElementById("modalDetail"));
const modalDel    = new bootstrap.Modal(document.getElementById("modalDel"));

/* ------------------------------------------------------------------ */
/*  API helpers                                                         */
/* ------------------------------------------------------------------ */
async function api(method, path, body) {
  const opts = { method, headers: { "Content-Type": "application/json" } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `Errore ${res.status}`);
  }
  return res.json();
}

/* ------------------------------------------------------------------ */
/*  Load + render                                                       */
/* ------------------------------------------------------------------ */
async function carica(q = "") {
  const url = q ? `/api/contatti?q=${encodeURIComponent(q)}` : "/api/contatti";
  contatti = await api("GET", url);
  render();
}

function render() {
  const data = [...contatti].sort((a, b) => {
    let va = (a[sortCol] ?? "").toString().toLowerCase();
    let vb = (b[sortCol] ?? "").toString().toLowerCase();
    if (sortCol === "tariffa") { va = parseFloat(a.tariffa) || 0; vb = parseFloat(b.tariffa) || 0; }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  document.getElementById("emptyMsg").style.display = data.length ? "none" : "block";
  document.getElementById("countMsg").textContent =
    data.length ? `${data.length} contatto/i` : "";

  data.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(c.cognome)}</td>
      <td>${esc(c.nome)}</td>
      <td>${esc(c.azienda)}</td>
      <td>${esc(c.reparto)}</td>
      <td>${c.telefono ? `<a href="tel:${esc(c.telefono)}">${esc(c.telefono)}</a>` : ""}</td>
      <td>${c.cellulare ? `<a href="tel:${esc(c.cellulare)}">${esc(c.cellulare)}</a>` : ""}</td>
      <td>${c.email ? `<a href="mailto:${esc(c.email)}">${esc(c.email)}</a>` : ""}</td>
      <td class="text-end">
        ${c.tariffa != null
          ? `<span class="badge badge-tariffa rounded-pill">${formatTariffa(c.tariffa, c.valuta)}</span>`
          : ""}
      </td>
      <td class="commento-cell" title="${esc(c.commenti)}">${esc(c.commenti)}</td>
      <td onclick="event.stopPropagation()">
        <button class="btn btn-outline-primary btn-action me-1"
                onclick="apriDettaglio(${c.id})" title="Dettaglio">
          <i class="bi bi-eye"></i>
        </button>
        <button class="btn btn-outline-warning btn-action me-1"
                onclick="apriModifica(${c.id})" title="Modifica">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="btn btn-outline-danger btn-action"
                onclick="confermaDel(${c.id})" title="Elimina">
          <i class="bi bi-trash"></i>
        </button>
      </td>`;
    tr.addEventListener("click", () => apriDettaglio(c.id));
    tbody.appendChild(tr);
  });
}

function esc(v) {
  if (!v) return "";
  return String(v)
    .replace(/&/g, "&amp;").replace(/</g, "&lt;")
    .replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

function formatTariffa(val, valuta) {
  return parseFloat(val).toFixed(2) + " " + (valuta || "EUR");
}

/* ------------------------------------------------------------------ */
/*  Ordinamento colonne                                                 */
/* ------------------------------------------------------------------ */
document.querySelectorAll("th[data-col]").forEach(th => {
  th.addEventListener("click", () => {
    const col = th.dataset.col;
    if (sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = true; }
    render();
  });
});

/* ------------------------------------------------------------------ */
/*  Ricerca                                                             */
/* ------------------------------------------------------------------ */
let searchTimer;
document.getElementById("searchBox").addEventListener("input", e => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => carica(e.target.value.trim()), 300);
});

/* ------------------------------------------------------------------ */
/*  Nuovo contatto                                                      */
/* ------------------------------------------------------------------ */
function apriNuovo() {
  document.getElementById("fId").value = "";
  document.getElementById("formContatto").reset();
  document.getElementById("modalTitle").textContent = "Nuovo contatto";
  document.getElementById("fValuta").value = "EUR";
  modalForm.show();
}

/* ------------------------------------------------------------------ */
/*  Modifica contatto                                                   */
/* ------------------------------------------------------------------ */
async function apriModifica(id) {
  const c = await api("GET", `/api/contatti/${id}`);
  document.getElementById("fId").value       = c.id;
  document.getElementById("fNome").value     = c.nome     || "";
  document.getElementById("fCognome").value  = c.cognome  || "";
  document.getElementById("fAzienda").value  = c.azienda  || "";
  document.getElementById("fReparto").value  = c.reparto  || "";
  document.getElementById("fTelefono").value = c.telefono || "";
  document.getElementById("fCellulare").value= c.cellulare|| "";
  document.getElementById("fEmail").value    = c.email    || "";
  document.getElementById("fTariffa").value  = c.tariffa != null ? c.tariffa : "";
  document.getElementById("fValuta").value   = c.valuta   || "EUR";
  document.getElementById("fCommenti").value = c.commenti || "";
  document.getElementById("modalTitle").textContent = "Modifica contatto";
  modalForm.show();
}

/* ------------------------------------------------------------------ */
/*  Salva (crea o aggiorna)                                            */
/* ------------------------------------------------------------------ */
async function salvaContatto() {
  const id = document.getElementById("fId").value;
  const body = {
    nome:      document.getElementById("fNome").value.trim(),
    cognome:   document.getElementById("fCognome").value.trim(),
    azienda:   document.getElementById("fAzienda").value.trim(),
    reparto:   document.getElementById("fReparto").value.trim(),
    telefono:  document.getElementById("fTelefono").value.trim(),
    cellulare: document.getElementById("fCellulare").value.trim(),
    email:     document.getElementById("fEmail").value.trim(),
    tariffa:   document.getElementById("fTariffa").value || null,
    valuta:    document.getElementById("fValuta").value,
    commenti:  document.getElementById("fCommenti").value.trim(),
  };
  try {
    if (id) await api("PUT",  `/api/contatti/${id}`, body);
    else    await api("POST", "/api/contatti",        body);
    modalForm.hide();
    await carica(document.getElementById("searchBox").value.trim());
  } catch(e) {
    alert(e.message);
  }
}

/* ------------------------------------------------------------------ */
/*  Dettaglio                                                           */
/* ------------------------------------------------------------------ */
async function apriDettaglio(id) {
  const c = await api("GET", `/api/contatti/${id}`);
  document.getElementById("detailTitle").textContent =
    `${c.cognome} ${c.nome}`;

  const righe = [
    ["Azienda",    c.azienda],
    ["Reparto",    c.reparto],
    ["Telefono",   c.telefono ? `<a href="tel:${esc(c.telefono)}">${esc(c.telefono)}</a>` : null],
    ["Cellulare",  c.cellulare ? `<a href="tel:${esc(c.cellulare)}">${esc(c.cellulare)}</a>` : null],
    ["Email",      c.email ? `<a href="mailto:${esc(c.email)}">${esc(c.email)}</a>` : null],
    ["Tariffa",    c.tariffa != null ? formatTariffa(c.tariffa, c.valuta) : null],
    ["Creato il",  c.creato_il],
    ["Modificato", c.modificato_il],
  ].filter(([, v]) => v).map(([l, v]) =>
    `<div class="mb-2"><span class="detail-label">${l}:</span>
     <span class="detail-value">${v}</span></div>`
  ).join("");

  const commento = c.commenti
    ? `<div class="mt-3"><div class="detail-label mb-1">Commenti:</div>
       <div class="detail-commento">${esc(c.commenti)}</div></div>`
    : "";

  document.getElementById("detailBody").innerHTML = righe + commento;
  document.getElementById("detailEditBtn").onclick = () => {
    modalDetail.hide();
    apriModifica(c.id);
  };
  modalDetail.show();
}

/* ------------------------------------------------------------------ */
/*  Elimina                                                             */
/* ------------------------------------------------------------------ */
let delId = null;
function confermaDel(id) {
  delId = id;
  const c = contatti.find(x => x.id === id);
  document.getElementById("delMsg").textContent =
    `Eliminare "${c ? c.cognome + " " + c.nome : id}"?`;
  modalDel.show();
}

document.getElementById("delConfirmBtn").addEventListener("click", async () => {
  if (!delId) return;
  try {
    await api("DELETE", `/api/contatti/${delId}`);
    modalDel.hide();
    await carica(document.getElementById("searchBox").value.trim());
  } catch(e) {
    alert(e.message);
  }
});

/* ------------------------------------------------------------------ */
/*  Init                                                                */
/* ------------------------------------------------------------------ */
carica();
</script>
</body>
</html>
